<div class="interactive-widget" id="blend-mode-widget">
    <div class="widget-controls" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
        <div class="control-group">
            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Blend Mode</label>
            <select id="blend-mode-select"
                style="width: 100%; padding: 8px; border-radius: 4px; background: var(--input-bg); border: 1px solid var(--border-subtle); color: var(--text-primary);">
                <option value="normal">Normal</option>
                <option value="add">Add</option>
                <option value="multiply">Multiply</option>
                <option value="screen">Screen</option>
                <option value="lighten">Lighten</option>
                <option value="darken">Darken</option>
                <option value="linear-burn">Linear Burn</option>
            </select>
        </div>
    </div>

    <div class="swatches-container"
        style="display: flex; gap: 30px; align-items: center; justify-content: center; margin-bottom: 20px; flex-wrap: wrap;">
        <!-- Bottom Layer -->
        <div class="swatch-group" style="text-align: center;">
            <div class="color-preview"
                style="width: 80px; height: 80px; border-radius: 8px; border: 2px solid var(--border-subtle); margin-bottom: 8px; position: relative; overflow: hidden;">
                <input type="color" id="bottom-color" value="#336699"
                    style="position: absolute; top: -10%; left: -10%; width: 120%; height: 120%; padding: 0; margin: 0; border: none; cursor: pointer;">
            </div>
            <div style="font-size: 0.9rem; color: var(--text-secondary);">Bottom Layer</div>
            <div id="bottom-rgb"
                style="font-family: monospace; font-size: 0.8rem; color: var(--text-muted); margin-top: 4px;"></div>
        </div>

        <div style="font-size: 1.5rem; color: var(--text-muted);">+</div>

        <!-- Top Layer -->
        <div class="swatch-group" style="text-align: center;">
            <div class="color-preview"
                style="width: 80px; height: 80px; border-radius: 8px; border: 2px solid var(--border-subtle); margin-bottom: 8px; position: relative; overflow: hidden;">
                <input type="color" id="top-color" value="#ff9900"
                    style="position: absolute; top: -10%; left: -10%; width: 120%; height: 120%; padding: 0; margin: 0; border: none; cursor: pointer;">
            </div>
            <div style="font-size: 0.9rem; color: var(--text-secondary);">Top Layer</div>
            <div id="top-rgb"
                style="font-family: monospace; font-size: 0.8rem; color: var(--text-muted); margin-top: 4px;"></div>
        </div>

        <div style="font-size: 1.5rem; color: var(--text-muted);">=</div>

        <!-- Result -->
        <div class="swatch-group" style="text-align: center;">
            <div id="result-swatch"
                style="width: 100px; height: 100px; border-radius: 12px; border: 2px solid var(--accent-primary); margin-bottom: 8px; background-color: #000; transition: background-color 0.2s;">
            </div>
            <div style="font-size: 0.9rem; font-weight: 600; color: var(--text-primary);">Result</div>
            <div id="result-rgb"
                style="font-family: monospace; font-size: 0.8rem; color: var(--text-muted); margin-top: 4px;"></div>
        </div>
    </div>

    <div class="formula-display"
        style="background: var(--code-bg); padding: 15px; border-radius: 8px; border-left: 4px solid var(--accent-primary); font-family: monospace; color: var(--text-primary); margin-top: 20px;">
        <div id="formula-text" style="white-space: pre-wrap; line-height: 1.5;"></div>
    </div>
</div>

<script>
    (function () {
        // Elements
        const bottomInput = document.getElementById('bottom-color');
        const topInput = document.getElementById('top-color');
        const modeSelect = document.getElementById('blend-mode-select');
        const resultSwatch = document.getElementById('result-swatch');
        const formulaText = document.getElementById('formula-text');

        const bottomRgbDisplay = document.getElementById('bottom-rgb');
        const topRgbDisplay = document.getElementById('top-rgb');
        const resultRgbDisplay = document.getElementById('result-rgb');

        // Helpers
        function hexToRgb(hex) {
            const r = parseInt(hex.substring(1, 3), 16) / 255;
            const g = parseInt(hex.substring(3, 5), 16) / 255;
            const b = parseInt(hex.substring(5, 7), 16) / 255;
            return { r, g, b };
        }

        function rgbToHex(r, g, b) {
            const toHex = (c) => {
                const hex = Math.round(Math.max(0, Math.min(1, c)) * 255).toString(16);
                return hex.length === 1 ? '0' + hex : hex;
            };
            return '#' + toHex(r) + toHex(g) + toHex(b);
        }

        function formatVal(v) {
            return v.toFixed(2);
        }

        function update() {
            const bottom = hexToRgb(bottomInput.value);
            const top = hexToRgb(topInput.value);
            const mode = modeSelect.value;

            let result = { r: 0, g: 0, b: 0 };
            let formula = '';

            // Calculate per channel
            const calcChannel = (b, t, mode) => {
                switch (mode) {
                    case 'normal': return t;
                    case 'add': return Math.min(1, b + t);
                    case 'multiply': return b * t;
                    case 'screen': return 1 - (1 - b) * (1 - t);
                    case 'lighten': return Math.max(b, t);
                    case 'darken': return Math.min(b, t);
                    case 'linear-burn': return Math.max(0, b + t - 1);
                    default: return t;
                }
            };

            result.r = calcChannel(bottom.r, top.r, mode);
            result.g = calcChannel(bottom.g, top.g, mode);
            result.b = calcChannel(bottom.b, top.b, mode);

            // Update UI
            resultSwatch.style.backgroundColor = rgbToHex(result.r, result.g, result.b);

            bottomRgbDisplay.textContent = `${formatVal(bottom.r)}, ${formatVal(bottom.g)}, ${formatVal(bottom.b)}`;
            topRgbDisplay.textContent = `${formatVal(top.r)}, ${formatVal(top.g)}, ${formatVal(top.b)}`;
            resultRgbDisplay.textContent = `${formatVal(result.r)}, ${formatVal(result.g)}, ${formatVal(result.b)}`;

            // Generate Formula Explanation (using Red channel as example)
            let formulaTemplate = '';
            let exampleMath = '';

            switch (mode) {
                case 'normal':
                    formulaTemplate = 'Result = Top';
                    exampleMath = `R = ${formatVal(top.r)}`;
                    break;
                case 'add':
                    formulaTemplate = 'Result = min(1, Bottom + Top)';
                    exampleMath = `R = min(1, ${formatVal(bottom.r)} + ${formatVal(top.r)}) = ${formatVal(result.r)}`;
                    break;
                case 'multiply':
                    formulaTemplate = 'Result = Bottom × Top';
                    exampleMath = `R = ${formatVal(bottom.r)} × ${formatVal(top.r)} = ${formatVal(result.r)}`;
                    break;
                case 'screen':
                    formulaTemplate = 'Result = 1 - (1 - Bottom) × (1 - Top)';
                    exampleMath = `R = 1 - (1 - ${formatVal(bottom.r)}) × (1 - ${formatVal(top.r)}) = ${formatVal(result.r)}`;
                    break;
                case 'lighten':
                    formulaTemplate = 'Result = max(Bottom, Top)';
                    exampleMath = `R = max(${formatVal(bottom.r)}, ${formatVal(top.r)}) = ${formatVal(result.r)}`;
                    break;
                case 'darken':
                    formulaTemplate = 'Result = min(Bottom, Top)';
                    exampleMath = `R = min(${formatVal(bottom.r)}, ${formatVal(top.r)}) = ${formatVal(result.r)}`;
                    break;
                case 'linear-burn':
                    formulaTemplate = 'Result = max(0, Bottom + Top - 1)';
                    exampleMath = `R = max(0, ${formatVal(bottom.r)} + ${formatVal(top.r)} - 1) = ${formatVal(result.r)}`;
                    break;
            }

            formulaText.innerHTML = `<strong>${mode.charAt(0).toUpperCase() + mode.slice(1)} Mode</strong>\nFormula: ${formulaTemplate}\nExample (Red Channel): ${exampleMath}`;
        }

        // Listeners
        bottomInput.addEventListener('input', update);
        topInput.addEventListener('input', update);
        modeSelect.addEventListener('change', update);

        // Init
        update();
    })();
</script>